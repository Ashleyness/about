[2020-09-09 Wed 11:30]

The queries below sound good. We will investigate the data and create groups for each kind of query. Then we will regularly run the queries and record response times. Those response times will guide our work and show improvements.

Tentative plan for Stefan and Keegan:

- Keegan and Stefan will work very closely together.
- Keegan finishes up Streaming work. Stefan may also help.
- Stefan will create a service which measures search performance for our target queries (prometheus + raw data of performance persisted).
- We will investigate our search data to create target queries we will measure soon.
- We will use this document as a living document + log of our work on this project. It will both communicate high level goals/progress as well as contain details over time. This is an experiment.

Next:

- Infrastructure/tools which allow us to easily experiment with zoekt and measure performance (a canary like system which also receives production traffic). We want this as early as possible since it will be so useful to experiments we try (there are lots of ideas we could tackle).

[2020-09-09 Wed 09:24]

First thing to accomplish is establishing a baseline of performance we want to monitor and improve. I think picking a small number of queries which we regularly run against sourcegraph.com and record the time it takes. We want to measure things that are important, here is a list of ideas to seed the discussion.

-   The sort of queries generated by code intel (type:symbol on a repo). Currently this is by far our most common query, and deserves some measurement and investigation. My gut tells me there are quick wins in our graphql layer. Possibly some more fundemental changes for how symbols works in Zoekt.
-   The sort of queries our users generally do:
    -   We should probably analyse a days worth of searches to try and understand this. Below are some guesses.
    -   Global literal search with 50k results. A user trying out sourcegraph and just typing something in.
    -   Global literal search with ~1k results. Somewhat representative of a search where the user has a goal in mind (ie somewhat specific like an error code).
    -   Global literal search with <5 results. Needle in haystack search.
-   The sort of queries structural search generates. IE regex literals broken up with \`.\*\` between them. We may want to add a goal around structural search perf rather. eg pick a query done by the new homepage and try make that fast (and scale). That should inform zoekt work as well as how structural search interacts with zoekt. (imagine if strutural search was integrated into zoekt's matcher? Or if structural search directly spoke to zoekt and asked zoekt to return file contents in results. So structural search doesn't fetch archives)

Some links to discussions around zoekt performance:

-   zoekt: ideas to improve performance and memory usage [#10445](https://github.com/sourcegraph/sourcegraph/issues/10445)
-   Reduce memory usage of zoekt-webserver [google/zoekt#86](https://github.com/google/zoekt/issues/86)
-   index: Use roaring bitmaps for content posting lists [zoekt#10](https://github.com/sourcegraph/zoekt/pull/10)
-   [Indexing all OSS Code · search · Sourcegraph](https://github.com/orgs/sourcegraph/teams/search/discussions/3)
-   [Ideas for longer term code search infrastructure projects · search · Sourcegraph](https://github.com/orgs/sourcegraph/teams/search/discussions/1)
-   [3.17 search backend planning · search · Sourcegraph](https://github.com/orgs/sourcegraph/teams/search/discussions/2)
-   [The first notes on search being a product in Sourcegraph · Cloud · Sourcegraph](https://github.com/orgs/sourcegraph/teams/cloud/discussions/2)
-   sourcegraph.com search performance regularly poor [#9359](https://github.com/sourcegraph/sourcegraph/issues/9359)
-   searching for rare strings with count:x qualifier in large installation (xxx k repos) times out [#11395](https://github.com/sourcegraph/sourcegraph/issues/11395)
-   RFC 30: Zoekt Horizontal Scaling [RFC 30](https://docs.google.com/document/d/18w8T_KzYxQye8wg1g01QpMOX4_ERTtbOxMBRYaOEkmk)
